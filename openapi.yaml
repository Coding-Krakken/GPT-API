openapi: 3.1.0
info:
  title: GPT Super-Agent Universal Control API
  description: Universal FastAPI-based control API for GPT agents to perform system operations (file, shell, code, package, git, apps, refactor, monitor, batch, etc.).
  version: 4.0.0
servers:
  - url: https://gpt-api.ngrok.app
paths:
  /shell:
    post:
      operationId: runShellCommand
      summary: Execute system-level commands with optional sudo, chaining, or background execution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - command
              properties:
                command:
                  type: string
                  minLength: 1
                  maxLength: 4096
                  description: Must be a non-empty string (max 4096 chars)
                run_as_sudo:
                  type: boolean
                background:
                  type: boolean
                shell:
                  type: string
      responses:
        '200':
          description: Shell command output
          content:
            application/json:
              schema:
                type: object
                properties:
                  stdout:
                    type: string
                  stderr:
                    type: string
                  exit_code:
                    type: integer
        '400':
          description: Invalid input (e.g., empty command)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /files:
    post:
      operationId: manageFiles
      summary: Perform all file-level operations via unified interface (single or batch)
      description: |
        Supports both single file operation (action+path) and batch (operations[]). If 'operations' is provided, it must be a non-empty array of file operation objects. Returns clear 400 errors for missing/invalid fields. Error responses are standardized.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Single file op (action+path) or batch (operations[])
              properties:
                action:
                  type: string
                  enum: [read, write, delete, copy, move, stat, exists, list]
                  description: Required for single op. Ignored if 'operations' is present.
                path:
                  type: string
                  description: Required for single op. Ignored if 'operations' is present.
                target_path:
                  type: string
                content:
                  type: string
                  maxLength: 1048576 # 1MB
                recursive:
                  type: boolean
                operations:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - action
                      - path
                    properties:
                      action:
                        type: string
                        enum: [read, write, delete, copy, move, stat, exists, list]
                      path:
                        type: string
                      target_path:
                        type: string
                      content:
                        type: string
                        maxLength: 1048576 # 1MB
                      recursive:
                        type: boolean
      responses:
        '200':
          description: Result of file operation (single or batch)
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      result:
                        type: string
                  - type: object
                    properties:
                      results:
                        type: array
                        items:
                          type: object
                          properties:
                            result:
                              type: string
        '400':
          description: Invalid input (e.g., missing required fields, invalid batch, or schema misuse)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /code:
    post:
      operationId: codeOps
      summary: Execute, test, lint, and manipulate code files in Python, JS, Bash, or Node.
      description: |
        Perform code actions (run, test, lint, fix, format, explain) on supported languages. All errors are structured. See docs for details. Required fields: action, language, and path or content. See externalDocs for full details.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [run, test, lint, fix, format, explain]
                  description: "Action to perform. Supported: run, test, lint, fix, format, explain."
                path:
                  type: string
                  description: "Path to the file. Required unless 'content' is provided. Unsafe or overlong paths are rejected."
                language:
                  type: string
                  description: |
                    Programming language. **Required.** Must be one of: 'python', 'js', 'bash', 'node'. Requests with missing or unsupported languages are rejected with `unsupported_language` error.
                  enum: [python, js, bash, node]
                args:
                  type: string
                  description: |
                    Optional CLI arguments. Only safe, whitelisted arguments are allowed per language/action. Malformed or unsafe arguments are rejected with `invalid_args` error.
                content:
                  type: string
                  description: |
                    Optional code content. If provided, will be written to a temp file and executed. Only supported for actions: run, test, lint, fix, format. Not supported for explain. Content is validated for type, size (max 100,000 chars), and (for Python) syntax before execution. Invalid content returns `invalid_content` error.
      responses:
        '200':
          description: Code action result
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      stdout:
                        type: string
                      stderr:
                        type: string
                      exit_code:
                        type: integer
                      duration:
                        type: number
                        description: Operation duration in seconds
                      content_hash:
                        type: string
                        description: SHA256 hash of content if content was provided
              examples:
                success:
                  summary: Successful code action
                  value:
                    stdout: "Test output"
                    stderr: ""
                    exit_code: 0
                    duration: 0.12
                no_tests:
                  summary: No tests found (exit code 5)
                  value:
                    error:
                      code: "no_tests_found"
                      message: "No tests were found in the specified file."
                    status: 200
                    stdout: ""
                    stderr: ""
                    exit_code: 5
                    duration: 0.05
        '400':
          description: Invalid input (e.g., empty command, invalid content, unsupported language, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /system:
    get:
      operationId: getSystemState
      summary: Retrieve system information, resources, users, and time data
      responses:
        '200':
          description: System information
          content:
            application/json:
              schema:
                type: object
                properties:
                  os:
                    type: string
                  cpu_usage_percent:
                    type: number
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /monitor:
    get:
      operationId: monitorHealthCheck
      summary: Health check for /monitor endpoint
      responses:
        '200':
          description: Health check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
    post:
      operationId: liveMonitor
      summary: Monitor metrics or subscribe to events
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [cpu, memory, disk, network, logs, filesystem, performance, custom]
                  description: |
                    Type of system metric to monitor.
                    - cpu: CPU usage percentage
                    - memory: Memory usage statistics
                    - disk: Disk usage statistics
                    - network: Network I/O statistics
                    - logs: Log stream monitoring (not yet implemented)
                    - filesystem: Filesystem usage statistics
                    - performance: Combined CPU, memory, disk performance metrics
                    - custom: Custom monitoring (not yet implemented)
                live:
                  type: boolean
                  description: |
                    If true, enables live monitoring mode. Currently not implemented - returns a message suggesting WebSocket or polling alternatives.
                    Supported values: false (default). true is not yet supported.
      responses:
        '200':
          description: Live monitoring data or stream token
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      result:
                        type: string
                        description: 'For non-structured or stream token responses.'
                  - type: object
                    properties:
                      result:
                        type: string
                        description: 'Response for unimplemented monitoring types.'
                        example: "Log stream not yet implemented"
                  - type: object
                    properties:
                      memory:
                        type: object
                        description: 'Memory usage details (for type=memory)'
                        properties:
                          total:
                            type: integer
                            description: 'Total system memory in bytes.'
                          used:
                            type: integer
                            description: 'Used memory in bytes.'
                          free:
                            type: integer
                            description: 'Free memory in bytes.'
                          percent:
                            type: number
                            description: 'Percent of memory used.'
                example:
                  memory:
                    total: 16777216
                    used: 8388608
                    free: 8388608
                    percent: 50.0
        '400':
          description: Invalid monitor type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_type:
                  summary: Invalid or unimplemented monitor type
                  value:
                    error:
                      code: "unknown_monitor_type"
                      message: "Unknown monitor type: custom. Supported: cpu, memory, disk, network, logs, filesystem, performance, custom."
                    status: 400

  /git:
    post:
      operationId: gitControl
      summary: Perform any Git operation (init, status, commit, push, pull, diff, merge, rebase)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - path
              properties:
                action:
                  type: string
                path:
                  type: string
                args:
                  type: string
      responses:
        '200':
          description: Git result output
          content:
            application/json:
              schema:
                type: object
                properties:
                  stdout:
                    type: string
                  stderr:
                    type: string
        '400':
          description: Invalid input (e.g., missing identity config)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /package:
    post:
      operationId: packageManager
      summary: Manage system or language packages and environments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                manager:
                  type: string
                action:
                  type: string
                  enum: [install, remove, update, list, upgrade]
                package:
                  type: string
      responses:
        '200':
          description: Package manager result
          content:
            application/json:
              schema:
                type: object
                properties:
                  stdout:
                    type: string
                  stderr:
                    type: string
        '400':
          description: Invalid input (e.g., empty command)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /apps:
    post:
      operationId: appControl
      summary: Launch, kill, or manipulate desktop and third-party applications, or manage windows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [launch, kill, list, list_windows, focus, minimize, maximize, move, resize]
                  description: |
                    Action to perform. 'list_windows' enumerates all open windows (platform-specific). 'focus', 'minimize', 'maximize', 'move', 'resize' are GUI actions.
                app:
                  type: string
                  description: Application name (for launch/kill/focus, or as window match hint)
                args:
                  type: string
                  description: Arguments to pass to the app (for launch)
                window_title:
                  type: string
                  description: Window title to match (for GUI actions)
                pid:
                  type: integer
                  description: Process ID to match (for GUI actions)
                window_index:
                  type: integer
                  description: Index of window to act on if multiple match (default 0)
                x:
                  type: integer
                  description: X position (for move/resize)
                y:
                  type: integer
                  description: Y position (for move/resize)
                width:
                  type: integer
                  description: Width (for resize)
                height:
                  type: integer
                  description: Height (for resize)
                # Pagination/filtering for 'list' action
                limit:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  description: Max number of apps to return (for 'list')
                offset:
                  type: integer
                  minimum: 0
                  description: Offset for pagination (for 'list')
                filter:
                  type: string
                  maxLength: 128
                  description: Filter apps by name substring (for 'list')
      responses:
        '200':
          description: App control or window management output
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      result:
                        type: string
                  - type: object
                    properties:
                      windows:
                        type: array
                        description: List of open windows (platform-specific fields)
                        items:
                          type: object
                          properties:
                            window_id:
                              type: string
                              description: Linux/X11 window ID (hex)
                            window_handle:
                              type: string
                              description: Windows window handle (decimal)
                            pid:
                              type: string
                              description: Process ID
                            process:
                              type: string
                              description: Process name
                            title:
                              type: string
                              description: Window title
                            desktop:
                              type: string
                              description: Linux/X11 desktop number
                            host:
                              type: string
                              description: Linux/X11 host
                            geometry:
                              type: object
                              properties:
                                x:
                                  type: integer
                                y:
                                  type: integer
                                width:
                                  type: integer
                                height:
                                  type: integer
                              description: Window geometry (Linux/X11)
                            state:
                              type: string
                              description: Window state (Linux/X11)
                      count:
                        type: integer
                        description: Number of windows returned
                      env:
                        type: object
                        description: Environment info (Linux/X11)
                        properties:
                          DISPLAY:
                            type: string
                          WAYLAND_DISPLAY:
                            type: string
        '400':
          description: Invalid input (e.g., empty command)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /apps/capabilities:
    get:
      operationId: getAppCapabilities
      summary: Get supported /apps features for the current OS/session
      responses:
        '200':
          description: Capabilities for /apps endpoint
          content:
            application/json:
              schema:
                type: object
                properties:
                  os:
                    type: string
                  gui:
                    type: boolean
                  process_management:
                    type: boolean
                  window_management:
                    type: boolean
                  multi_window:
                    type: boolean
                  geometry:
                    type: boolean
                  state:
                    type: boolean
                  wayland:
                    type: boolean
                  x11:
                    type: boolean
                  tools:
                    type: object
                    additionalProperties:
                      type: boolean
                  python_version:
                    type: string

  /refactor:
    post:
      operationId: refactorCode
      summary: Mass refactors, renames, substitutions, and code moves
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                search:
                  type: string
                  maxLength: 1024
                replace:
                  type: string
                  maxLength: 1024
                dry_run:
                  type: boolean
                files:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Refactor output
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      results:
                        type: array
                        items:
                          type: object
                  - type: object
                    properties:
                      result:
                        type: string
              examples:
                dry_run_noop:
                  summary: Dry-run with no matches
                  value:
                    result: "No matches found."
        '400':
          description: Invalid input (e.g., empty command)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /batch:
    post:
      operationId: bulkActions
      summary: Queue multiple commands, file edits, or code ops
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - operations
              properties:
                operations:
                  type: array
                  items:
                    type: object
                    required:
                      - action
                    properties:
                      action:
                        type: string
                      args:
                        type: object
                        additionalProperties: true
      responses:
        '200':
          description: Batch processing result
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
        '400':
          description: Invalid batch request (malformed operations)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
          required: [code, message]
        status:
          type: integer
        debug:
          type: array
          items:
            type: string
        trace:
          type: string

  # Enhanced GUI Control Layer Endpoints
  /gui/session:
    get:
      operationId: getGuiSession
      summary: Get comprehensive GUI session information with Wayland/X11 detection
      responses:
        '200':
          description: GUI session details
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_type:
                    type: string
                    enum: [wayland, x11]
                  compositor:
                    type: string
                  display:
                    type: string
                  wayland_display:
                    type: string
                  tools:
                    type: object
                    additionalProperties:
                      type: boolean
                  capabilities:
                    type: object
                    properties:
                      window_management:
                        type: boolean
                      wayland_introspection:
                        type: boolean
                      x11_fallback:
                        type: boolean
                      screenshot:
                        type: boolean
                      input_automation:
                        type: boolean
                      accessibility:
                        type: boolean
                  detection_methods:
                    type: array
                    items:
                      type: string
                  detection_latency_us:
                    type: integer

  /gui/test:
    get:
      operationId: testGuiEnvironment
      summary: Test GUI detection across different environments
      responses:
        '200':
          description: GUI environment test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  tests:
                    type: object
                    properties:
                      session_detection:
                        type: boolean
                      window_enumeration:
                        type: boolean
                      tool_availability:
                        type: boolean
                      fallback_methods:
                        type: boolean
                  overall_status:
                    type: string
                    enum: [healthy, degraded]
                  latency_us:
                    type: integer

  /apps_advanced/list_windows_detailed:
    get:
      operationId: listWindowsDetailed
      summary: Get detailed window list with position, size, state, focus, z-index
      responses:
        '200':
          description: Detailed window information
          content:
            application/json:
              schema:
                type: object
                properties:
                  windows:
                    type: array
                    items:
                      type: object
                      properties:
                        window_id:
                          type: string
                        desktop:
                          type: integer
                        pid:
                          type: integer
                        geometry:
                          type: object
                          properties:
                            x:
                              type: integer
                            y:
                              type: integer
                            width:
                              type: integer
                            height:
                              type: integer
                        title:
                          type: string
                        state:
                          type: string
                        focus:
                          type: boolean
                        z_index:
                          type: integer
                        method:
                          type: string
                  methods_tried:
                    type: array
                    items:
                      type: string
                  latency_us:
                    type: integer

  /apps_advanced/launch:
    post:
      operationId: launchAppWithTracking
      summary: Launch app with PID tracking and GUI metadata attachment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - app
              properties:
                app:
                  type: string
                args:
                  type: string
                workspace:
                  type: integer
                geometry:
                  type: object
                  properties:
                    x:
                      type: integer
                    y:
                      type: integer
                    width:
                      type: integer
                    height:
                      type: integer
      responses:
        '200':
          description: App launch result with PID
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      status:
                        type: string
                      pid:
                        type: integer
                      app:
                        type: string
                      metadata:
                        type: object
                  latency_us:
                    type: integer

  /apps_advanced/focus:
    post:
      operationId: focusWindow
      summary: Focus a specific window
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
              properties:
                action:
                  type: string
                  enum: [focus]
                window_id:
                  type: string
                pid:
                  type: integer
                window_title:
                  type: string
      responses:
        '200':
          description: Window focus result
        '404':
          description: Window not found

  /apps_advanced/resize:
    post:
      operationId: resizeWindow
      summary: Resize a window
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - x
                - y
                - width
                - height
              properties:
                action:
                  type: string
                  enum: [resize]
                window_id:
                  type: string
                x:
                  type: integer
                y:
                  type: integer
                width:
                  type: integer
                  minimum: 1
                height:
                  type: integer
                  minimum: 1
      responses:
        '200':
          description: Window resize result

  /apps_advanced/move:
    post:
      operationId: moveWindow
      summary: Move a window to new position
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - x
                - y
              properties:
                action:
                  type: string
                  enum: [move]
                window_id:
                  type: string
                x:
                  type: integer
                y:
                  type: integer
      responses:
        '200':
          description: Window move result

  /apps_advanced/screenshot:
    post:
      operationId: captureScreenshot
      summary: Capture window or screen screenshot
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                window_id:
                  type: string
                format:
                  type: string
                  enum: [png, jpg]
                  default: png
      responses:
        '200':
          description: Screenshot capture result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      screenshot_path:
                        type: string
                      format:
                        type: string
                      file_size:
                        type: integer
                      success:
                        type: boolean
                  latency_us:
                    type: integer

  /input_enhanced/type:
    post:
      operationId: typeText
      summary: Type text via input automation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - text
              properties:
                action:
                  type: string
                  enum: [type]
                text:
                  type: string
                window_id:
                  type: string
      responses:
        '200':
          description: Text input result

  /input_enhanced/keyboard:
    post:
      operationId: sendKeypress
      summary: Send keyboard input (key press)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - key
              properties:
                action:
                  type: string
                  enum: [key]
                key:
                  type: string
                window_id:
                  type: string
      responses:
        '200':
          description: Keyboard input result

  /input_enhanced/mouse:
    post:
      operationId: mouseAction
      summary: Perform mouse actions (click, move)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
              properties:
                action:
                  type: string
                  enum: [click, move]
                x:
                  type: integer
                y:
                  type: integer
                button:
                  type: string
                  enum: [left, right, middle]
                  default: left
      responses:
        '200':
          description: Mouse action result

  /vision/ocr:
    post:
      operationId: performOcr
      summary: OCR text recognition from screenshot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - screenshot_path
              properties:
                screenshot_path:
                  type: string
      responses:
        '200':
          description: OCR result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      text:
                        type: string
                      confidence:
                        type: number
                      words:
                        type: array
                        items:
                          type: object
                      success:
                        type: boolean
                  latency_us:
                    type: integer

  /vision/find_element:
    post:
      operationId: findVisualElement
      summary: Visual element recognition with OpenCV
      responses:
        '200':
          description: Visual element recognition result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      elements:
                        type: array
                        items:
                          type: object
                      method:
                        type: string
                      success:
                        type: boolean
                  latency_us:
                    type: integer

  /apps_advanced/mock_window:
    post:
      operationId: createMockWindow
      summary: Create a mock window for testing (Xvfb or dummy window)
      responses:
        '200':
          description: Mock window creation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      mock_pid:
                        type: integer
                      type:
                        type: string
                      success:
                        type: boolean
                  latency_us:
                    type: integer
